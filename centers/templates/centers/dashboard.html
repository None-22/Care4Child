{% extends 'base.html' %}
{% load static %}

{% block page_title %}لوحة المعلومات والتقارير{% endblock %}

{% block content %}
<!-- KPI Cards Row -->
<div class="row g-4 mb-4">
    <!-- Total Children -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-hover overflow-hidden">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted fw-bold text-uppercase mb-1 small">إجمالي الأطفال</p>
                        <h2 class="fw-bolder text-primary mb-0">{{ total_children }}</h2>
                    </div>
                    <div class="icon-shape bg-light text-primary rounded-circle shadow-sm">
                        <i class="fas fa-child fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="badge bg-soft-success text-success">
                        <i class="fas fa-check small me-1"></i> نشط
                    </span>
                    <span class="text-muted small ms-2">مسجلين في النظام</span>
                </div>
                <!-- Decoration -->
                <div class="position-absolute bottom-0 start-0 w-100 bg-primary opacity-10" style="height: 4px;"></div>
            </div>
        </div>
    </div>

    <!-- Today's Vaccines -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-hover overflow-hidden">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted fw-bold text-uppercase mb-1 small">لقاحات اليوم</p>
                        <h2 class="fw-bolder text-info mb-0">{{ today_records }}</h2>
                    </div>
                    <div class="icon-shape bg-light text-info rounded-circle shadow-sm">
                        <i class="fas fa-syringe fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="text-muted small">عملية توثيق اليوم</span>
                </div>
                <div class="position-absolute bottom-0 start-0 w-100 bg-info opacity-10" style="height: 4px;"></div>
            </div>
        </div>
    </div>

    <!-- Overdue -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-hover overflow-hidden">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted fw-bold text-uppercase mb-1 small">متأخرين عن الموعد</p>
                        <h2 class="fw-bolder text-danger mb-0">{{ overdue_appointments }}</h2>
                    </div>
                    <div class="icon-shape bg-light text-danger rounded-circle shadow-sm">
                        <i class="fas fa-user-clock fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="{% url 'centers:registry' %}?status=overdue"
                        class="text-danger small text-decoration-none stretched-link">
                        عرض التفاصيل <i class="fas fa-arrow-left small"></i>
                    </a>
                </div>
                <div class="position-absolute bottom-0 start-0 w-100 bg-danger opacity-10" style="height: 4px;"></div>
            </div>
        </div>
    </div>

    <!-- Completion Rate -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-hover overflow-hidden">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted fw-bold text-uppercase mb-1 small">نسبة التحصين</p>
                        <h2 class="fw-bolder text-success mb-0">{{ completion_rate }}%</h2>
                    </div>
                    <div class="icon-shape bg-light text-success rounded-circle shadow-sm">
                        <i class="fas fa-chart-pie fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ completion_rate }}%"
                        aria-valuenow="{{ completion_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="position-absolute bottom-0 start-0 w-100 bg-success opacity-10" style="height: 4px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mb-4">
    <!-- Activity Chart -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold m-0 text-primary">نشاط التحصين (آخر 7 أيام)</h5>
                <button class="btn btn-sm btn-light"><i class="fas fa-ellipsis-h"></i></button>
            </div>
            <div class="card-body">
                <canvas id="activityChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Status Doughnut -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="fw-bold m-0 text-primary">حالة المواعيد القادمة</h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center position-relative">
                <canvas id="statusChart" style="max-height: 250px;"></canvas>
            </div>
            <div class="card-footer bg-transparent border-0 text-center text-muted small pb-3">
                <i class="fas fa-info-circle me-1"></i> يظهر هذا الرسم نسبة الالتزام بالمواعيد
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity & Quick Actions -->
<div class="row g-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold m-0 text-primary">سجل النشاط الأخير</h5>
                <a href="{% url 'centers:registry' %}" class="btn btn-sm btn-outline-primary rounded-pill px-3">عرض
                    السجل الكامل</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4">الطفل</th>
                            <th>اللقاح</th>
                            <th>الجرعة</th>
                            <th>الموظف</th>
                            <th>التاريخ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in recent_records %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-2"
                                        style="width: 32px; height: 32px;">
                                        {{ record.child.full_name|slice:":1" }}
                                    </div>
                                    <span class="fw-bold text-dark">{{ record.child.full_name }}</span>
                                </div>
                            </td>
                            <td><span class="badge bg-soft-info text-info">{{ record.vaccine.name_ar }}</span></td>
                            <td>{{ record.dose_number }}</td>
                            <td>{{ record.staff.first_name }} {{ record.staff.last_name }}</td>
                            <td class="text-muted small">{{ record.date_given|date:"Y/m/d" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">لا يوجد نشاط حديث</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- Chart.js Configuration ---

    // 1. Activity Line Chart
    const ctxActivity = document.getElementById('activityChart').getContext('2d');
    const gradient = ctxActivity.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(52, 152, 219, 0.4)'); // Primary Color
    gradient.addColorStop(1, 'rgba(52, 152, 219, 0.0)');

    new Chart(ctxActivity, {
        type: 'line',
        data: {
            labels: {{ chart_labels| safe }}, // From Django View
        datasets: [{
            label: 'عدد التطعيمات',
            data: {{ chart_data| safe }}, // From Django View
        borderColor: '#3498db',
        backgroundColor: gradient,
        borderWidth: 2,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#3498db',
        pointRadius: 4,
        pointHoverRadius: 6,
        fill: true,
        tension: 0.4
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { borderDash: [2, 4], color: '#f0f0f0' },
                ticks: { precision: 0 }
            },
            x: {
                grid: { display: false }
            }
        }
    }
    });

    // 2. Status Doughnut Chart
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['قادم خلال أسبوع', 'متأخر', 'أخرى'],
            datasets: [{
                data: [{{ upcoming_appointments }}, {{ overdue_appointments }}, 5], // Added dummy 'other' for visual balance if 0
        backgroundColor: [
            '#f1c40f', // Warning/Upcoming
            '#e74c3c', // Danger/Overdue
            '#ecf0f1'  // Grey/Other
        ],
        hoverOffset: 4,
        borderWidth: 0
    }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: { usePointStyle: true, padding: 20 }
            }
        }
    }
    });
</script>

<style>
    /* Custom Stylings for Premium Feel */
    .icon-shape {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .08) !important;
    }

    .bg-soft-info {
        background-color: rgba(23, 162, 184, 0.1);
    }

    .bg-soft-success {
        background-color: rgba(40, 167, 69, 0.1);
    }

    .card {
        border-radius: 12px;
    }
</style>

{% endblock %}