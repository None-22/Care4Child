{% extends 'base.html' %}
{% load static %}

{% block page_title %}Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠØ©{% endblock %}

{% block content %}

<!-- Quick Stats & Alerts Row -->
<div class="row g-4 mb-4">
    <!-- 1. Efficiency Gauge -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 position-relative overflow-hidden">
            <div class="card-body text-center">
                <h6 class="text-muted text-uppercase small fw-bold mb-3">ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…ÙŠ</h6>
                <div class="position-relative" style="height: 150px; width: 100%;">
                    <canvas id="efficiencyChart"></canvas>
                    <div class="position-absolute top-50 start-50 translate-middle mt-4">
                        <h3 class="fw-bolder mb-0 text-dark">{{ efficiency_rate }}%</h3>
                        <small class="text-muted">{{ today_actual }} / {{ today_target }}</small>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-center small text-muted">
                <i class="fas fa-info-circle me-1"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…
            </div>
        </div>
    </div>

    <!-- 2. Zero-Dose Alert (Critical) -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 bg-soft-danger text-danger">
            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                <div class="icon-shape bg-white text-danger rounded-circle shadow-sm mb-3">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
                <h2 class="fw-bolder mb-0">{{ zero_dose_count }}</h2>
                <p class="mb-0 fw-bold small text-uppercase">Ø£Ø·ÙØ§Ù„ "ØµÙØ± Ø¬Ø±Ø¹Ø§Øª"</p>
                <small class="mt-2 opacity-75">ÙŠØ­ØªØ§Ø¬ÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ø© ÙÙˆØ±ÙŠØ©!</small>
            </div>
        </div>
    </div>

    <!-- 3. Total Children -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø·ÙØ§Ù„</h6>
                    <h2 class="fw-bolder text-primary mb-0">{{ total_children }}</h2>
                    <span class="badge bg-soft-success text-success mt-2">
                        <i class="fas fa-check-circle me-1"></i> {{ completed_children }} Ù…ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­ØµÙŠÙ†
                    </span>
                </div>
                <div class="icon-shape bg-light text-primary rounded-circle shadow-sm ms-3">
                    <i class="fas fa-child fa-2x"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions (Manager Focused) -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 bg-primary text-white">
            <div class="card-body d-flex flex-column justify-content-center">
                <h5 class="fw-bold mb-3"><i class="fas fa-bolt me-2"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h5>
                <a href="{% url 'centers:add_child' %}" class="btn btn-light text-primary w-100 mb-2 fw-bold shadow-sm">
                    <i class="fas fa-plus me-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø·ÙÙ„ Ø¬Ø¯ÙŠØ¯
                </a>
                <a href="{% url 'centers:registry' %}" class="btn btn-outline-light w-100 fw-bold">
                    <i class="fas fa-syringe me-2"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Main Analytics Row -->
<div class="row g-4 mb-4">
    <!-- 4. Dropout Funnel (Bar Chart) -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="fw-bold m-0 text-primary">
                    <i class="fas fa-filter me-2 text-muted"></i> Ù‚Ù…Ø¹ Ø§Ù„ØªØ³Ø±Ø¨ (Dropout Funnel)
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <canvas id="dropoutChart" style="max-height: 250px;"></canvas>
                    </div>
                    <div class="col-md-4 text-center border-start">
                        <h6 class="text-muted small fw-bold text-uppercase">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ø±Ø¨</h6>
                        <h2
                            class="fw-bolder text-{% if dropout_rate > 5 %}danger{% else %}success{% endif %} display-4 mb-0">
                            {{ dropout_rate }}%
                        </h2>
                        <p class="small text-muted mt-2">
                            Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ§Ù„Ø«Ø§Ù„Ø«Ø©.
                            {% if dropout_rate > 5 %}
                            <br><span class="text-danger fw-bold">ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†!</span>
                            {% else %}
                            <br><span class="text-success fw-bold">Ù…Ù…ØªØ§Ø²!</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Age Distribution (Pie) -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="fw-bold m-0 text-primary">Ø¹Ù…Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h5>
            </div>
            <div class="card-body position-relative d-flex justify-content-center align-items-center">
                <canvas id="ageChart" style="max-height: 250px;"></canvas>
            </div>
            <div class="card-footer bg-transparent border-0 text-center small text-muted">
                Ù…Ø¯Ù‰ ÙˆØ¹ÙŠ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙƒØ±
            </div>
        </div>
    </div>
</div>

<!-- Operational Analytics Row -->
<div class="row g-4 mb-4">
    <!-- 6. Weekly Peak Activity (Heatmap Style Bar) -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="fw-bold m-0 text-primary">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h5>
            </div>
            <div class="card-body">
                <canvas id="peakChart" style="max-height: 200px;"></canvas>
                <div class="alert alert-soft-warning mt-3 mb-0 small">
                    <i class="fas fa-lightbulb me-1"></i> Ù†ØµÙŠØ­Ø©: Ø²Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø°Ø§Øª Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø·ÙˆÙ„.
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Demand Forecast (Area Chart) -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="fw-bold m-0 text-primary">
                    <i class="fas fa-crystal-ball me-2 text-muted"></i> Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="forecastChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Vaccinations (Requested Replacement) -->
<div class="row g-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold m-0 text-primary">ğŸ“ Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ·Ø¹ÙŠÙ…</h5>
                <a href="{% url 'centers:registry' %}" class="btn btn-sm btn-outline-primary rounded-pill px-3">Ø¹Ø±Ø¶
                    Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4">Ø§Ù„Ø·ÙÙ„</th>
                                <th>Ø§Ù„Ù„Ù‚Ø§Ø­</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ·Ø¹ÙŠÙ…</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in recent_records %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ record.child.full_name }}</td>
                                <td><span class="badge bg-soft-info text-info">{{ record.vaccine.name_ar }}</span></td>
                                <td><span class="badge bg-light text-dark border">{{ record.dose_number }}</span></td>
                                <td class="text-muted">{{ record.date_given|date:"Y/m/d" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¯ÙŠØ«Ø©</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- 1. Efficiency Gauge (Doughnut) ---
    new Chart(document.getElementById('efficiencyChart'), {
        type: 'doughnut',
        data: {
            labels: ['Ø§Ù„Ù…Ù†Ø¬Ø²', 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'],
            datasets: [{
                data: [{{ today_actual }}, {{ today_target }} - {{ today_actual }} > 0 ? {{ today_target }} - {{ today_actual }} : 0],
        backgroundColor: ['#2ecc71', '#ecf0f1'],
        borderWidth: 0,
        circumference: 180,
        rotation: -90,
        cutout: '85%'
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } }
    }
    });

    // --- 4. Dropout Funnel (Bar) ---
    new Chart(document.getElementById('dropoutChart'), {
        type: 'bar',
        data: {
            labels: ['Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Dose 1)', 'Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Dose 3)'],
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„',
                data: [{{ dose_1_count }}, {{ dose_3_count }}],
        backgroundColor: ['#3498db', '#9b59b6'],
        borderRadius: 8,
        barPercentage: 0.6
    }]
        },
        options: {
        indexAxis: 'y', // Horizontal Bar makes it look like a funnel
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { grid: { display: false } }, y: { grid: { display: false } } },
        plugins: { legend: { display: false } }
    }
    });

    // --- 5. Age Distribution (Pie) ---
    new Chart(document.getElementById('ageChart'), {
        type: 'pie',
        data: {
            labels: {{ age_labels| safe }},
        datasets: [{
            data: {{ age_data| safe }},
        backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c'],
        borderWidth: 2,
        borderColor: '#fff'
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
    }
    });

    // --- 6. Weekly Peak (Bar) ---
    new Chart(document.getElementById('peakChart'), {
        type: 'bar',
        data: {
            labels: {{ weekly_labels| safe }},
        datasets: [{
            label: 'Ø§Ù„Ø¶ØºØ· Ø§Ù„ÙŠÙˆÙ…ÙŠ',
            data: {{ weekly_activity| safe }},
        backgroundColor: function (context) {
            const value = context.raw;
            // Heatmap colors: Low=Green, High=Red
            const max = Math.max(...{{ weekly_activity| safe }});
    const alpha = value / max;
    if (alpha > 0.8) return '#e74c3c'; // Red
    if (alpha > 0.4) return '#f39c12'; // Orange
    return '#2ecc71'; // Green
                },
    borderRadius: 4
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } },
        plugins: { legend: { display: false } }
    }
    });

    // --- 7. Demand Forecast (Line Area) ---
    const ctxForecast = document.getElementById('forecastChart').getContext('2d');
    const gradientForecast = ctxForecast.createLinearGradient(0, 0, 0, 300);
    gradientForecast.addColorStop(0, 'rgba(155, 89, 182, 0.4)'); // Purple
    gradientForecast.addColorStop(1, 'rgba(155, 89, 182, 0.0)');

    new Chart(ctxForecast, {
        type: 'line',
        data: {
            labels: {{ forecast_labels| safe }},
        datasets: [{
            label: 'Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹',
            data: {{ forecast_data| safe }},
        borderColor: '#9b59b6',
        backgroundColor: gradientForecast,
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#9b59b6',
        pointRadius: 5
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } } },
        plugins: { legend: { display: false } }
    }
    });
</script>

<style>
    /* Premium Styles */
    .icon-shape {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bg-soft-danger {
        background-color: rgba(231, 76, 60, 0.1);
    }

    .bg-soft-success {
        background-color: rgba(46, 204, 113, 0.1);
    }

    .bg-soft-warning {
        background-color: rgba(241, 196, 15, 0.1);
    }

    .card {
        transition: transform 0.2s;
        border-radius: 12px;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .1) !important;
    }
</style>

{% endblock %}