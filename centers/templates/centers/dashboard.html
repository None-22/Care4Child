{% extends 'base.html' %}
{% load centers_extras %}

{% block page_title %}لوحة المعلومات{% endblock %}

{% block content %}
<!-- Stats Row -->
<div class="row g-3 my-2">
    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm card-shine d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2">{{ total_children_count|default:"0" }}</h3> <!-- Need to pass this context -->
                <p class="fs-5 text-muted">إجمالي الأطفال</p>
            </div>
            <i class="fas fa-baby fs-1 primary-text border rounded-full secondary-bg p-3"></i>
        </div>
    </div>

    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm card-shine d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2">0</h3> <!-- Placeholder -->
                <p class="fs-5 text-muted">لقاحات اليوم</p>
            </div>
            <i class="fas fa-syringe fs-1 text-danger border rounded-full secondary-bg p-3"></i>
        </div>
    </div>

    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm card-shine d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2">0</h3> <!-- Placeholder -->
                <p class="fs-5 text-muted">المواعيد القادمة</p>
            </div>
            <i class="fas fa-calendar-alt fs-1 text-warning border rounded-full secondary-bg p-3"></i>
        </div>
    </div>

    <div class="col-md-3">
        <a href="{% url 'centers:add_child' %}" class="text-decoration-none">
            <div class="p-3 shadow-sm card-shine d-flex justify-content-center align-items-center rounded bg-primary text-white h-100"
                style="cursor: pointer;">
                <div class="text-center">
                    <i class="fas fa-plus-circle fs-1 mb-2"></i>
                    <h4 class="m-0 text-white">تسجيل طفل</h4>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Search Bar -->
<form method="get" action="." class="mb-4">
    <div class="input-group input-group-lg shadow-sm">
        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
        <input type="text" name="q" class="form-control border-start-0 ps-0"
            placeholder="بحث عن طفل (الاسم، اسم الأب، رقم العائلة...)" value="{{ request.GET.q|default:'' }}">
        <button class="btn btn-primary px-4" type="submit">بحث</button>
        {% if request.GET.q %}
        <a href="." class="btn btn-outline-secondary px-3" title="إلغاء البحث"><i class="fas fa-times"></i></a>
        {% endif %}
    </div>
</form>

<!-- Table Section -->
<div class="row my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fs-4"><i class="fas fa-book-medical me-2"></i>سجل التحصين الإلكتروني</h3>
        <span class="badge bg-primary">{{ total_children_count }} طفل</span>
    </div>

    <div class="col">
        <div class="table-responsive shadow-sm rounded bg-white">
            <table class="table table-bordered align-middle mb-0 text-center registry-table" style="min-width: 1500px;">
                <thead style="position: sticky; top: 0; z-index: 20;">
                    <!-- Row 1: Vaccine Groups -->
                    <tr>
                        <th rowspan="2" class="sticky-col-start align-middle shadow-sm bg-primary text-white"
                            style="width: 250px; z-index: 30; border: 1px solid #2980b9;">
                            <div class="py-2">الطفل</div>
                        </th>
                        {% for group in grouped_headers %}
                        <th colspan="{{ group.doses|length }}" class="text-center align-middle py-3"
                            style="background-color: #3498db; color: white; border: 1px solid #2980b9; {% if forloop.last %}border-left: 2px solid #1a5276;{% endif %}">
                            {{ group.label }}
                        </th>
                        {% endfor %}
                    </tr>
                    <!-- Row 2: Doses & Age -->
                    <tr>
                        {% for group in grouped_headers %}
                        {% for schedule in group.doses %}
                        <th class="small align-middle bg-light"
                            style="min-width: 100px; border: 1px solid #dee2e6; color: #555; font-weight: 600; {% if forloop.last %}border-left: 2px solid #adb5bd;{% endif %}">
                            <div class="d-flex flex-column py-1">
                                <span>جرعة {{ schedule.dose_number }}</span>
                                <span class="text-muted fw-normal mt-1" style="font-size: 0.75rem;">
                                    {{ schedule.age_in_months|format_age_ar }}
                                </span>
                            </div>
                        </th>
                        {% endfor %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in child_rows %}
                    <tr>
                        <td class="sticky-col-start fw-bold text-start p-3"
                            style="z-index: 5; background-color: #fff; border: 1px solid #dee2e6; border-left: 2px solid #dee2e6;">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-2"
                                    style="width: 35px; height: 35px; min-width: 35px; font-size: 0.9em;">
                                    {{ row.child.full_name|slice:":1" }}
                                </div>
                                <div>
                                    <a href="{% url 'centers:child_detail' row.child.id %}"
                                        class="text-decoration-none text-dark stretched-link"
                                        style="font-size: 0.95rem;">
                                        {{ row.child.full_name }}
                                    </a>
                                </div>
                            </div>
                        </td>

                        {% for cell in row.cells %}
                        <td class="align-middle {% if cell.is_group_end %}border-group-end{% endif %} {% if cell.status == 'taken' %}bg-status-taken{% elif cell.status == 'overdue' %}bg-status-overdue{% elif cell.status == 'due' %}bg-status-due{% else %}bg-status-future{% endif %}"
                            style="border: 1px solid #dee2e6;">

                            {% if cell.status == 'taken' %}
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-check text-success fs-5"></i>
                                <span class="text-success mt-1" style="font-size: 0.75em; font-weight: bold;">
                                    {{ cell.date|date:'Y/m/d' }}
                                </span>
                            </div>
                            {% elif cell.status == 'overdue' %}
                            <div class="text-danger fw-bold" style="font-size: 0.85em;">
                                {{ cell.date|date:"Y/m/d" }}
                            </div>
                            {% elif cell.status == 'due' %}
                            <div class="text-warning fw-bold" style="font-size: 0.85em;">
                                {{ cell.date|date:"Y/m/d" }}
                            </div>
                            {% else %}
                            <div class="text-muted small" style="font-size: 0.8em; opacity: 0.4;">
                                {{ cell.date|date:"Y/m/d" }}
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="100" class="text-center py-5 text-muted">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p>لا توجد بيانات لعرضها. قم بإضافة أطفال أولاً.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* Premium Dashboard Styles */

    /* Sticky Column - The Anchor */
    .sticky-col-start {
        position: sticky;
        right: 0;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.08);
        /* More refined shadow */
        border-right: 1px solid #dee2e6;
        background-color: #fff;
        /* Ensure opacity */
    }

    /* Table Headers */
    th {
        white-space: nowrap;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        /* Fallback until Cairo is loaded */
    }

    /* Status Backgrounds - Soft Pastels */
    .bg-status-taken {
        background-color: #dcfce7;
        color: #14532d;
    }

    .bg-status-overdue {
        background-color: #fee2e2;
        color: #7f1d1d;
    }

    .bg-status-due {
        background-color: #fef3c7;
        color: #78350f;
    }

    .bg-status-future {
        background-color: #ffffff;
    }

    /* Borders */
    .border-group-end {
        border-left: 2px solid #94a3b8 !important;
        /* Blue-grey for professional separation */
    }

    /* Card Polish */
    .card-shine {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e2e8f0;
    }

    .card-shine:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Registry Table */
    .registry-table {
        border-collapse: separate;
        border-spacing: 0;
    }
</style>
{% endblock %}