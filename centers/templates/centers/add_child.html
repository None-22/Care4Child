{% extends 'base.html' %}

{% block page_title %}تسجيل طفل جديد{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card-luxury p-5 animate-slide-up delay-1">
            <div class="text-center mb-5">
                <div class="bg-primary text-white rounded-circle d-inline-flex justify-content-center align-items-center mb-3"
                    style="width: 70px; height: 70px;">
                    <i class="fas fa-baby-carriage fa-2x"></i>
                </div>
                <h3 class="fw-bold">بيانات الطفل الجديد</h3>
                <p class="text-muted">يرجى تعبئة البيانات بدقة لإصدار الكرت الإلكتروني فوراً</p>
            </div>

            <form method="POST">
                {% csrf_token %}

                <h5 class="text-primary mb-3 border-bottom pb-2">
                    <i class="fas fa-id-card me-2"></i>البيانات الأساسية
                </h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-12">
                        <div class="form-floating">
                            <input type="text" name="child_name" class="form-control" id="floatingChildName"
                                placeholder="الاسم الرباعي" required>
                            <label for="floatingChildName">اسم الطفل (الرباعي)</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" name="dob" class="form-control flatpickr-date" id="floatingDob"
                                placeholder="تاريخ الميلاد" required>
                            <label for="floatingDob">تاريخ الميلاد</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <select name="gender" class="form-select" id="floatingGender">
                                <option value="M">ذكر</option>
                                <option value="F">أنثى</option>
                            </select>
                            <label for="floatingGender">الجنس</label>
                        </div>
                    </div>
                </div>

                <h5 class="text-primary mb-3 border-bottom pb-2 mt-5">
                    <i class="fas fa-map-marker-alt me-2"></i>بيانات مكان الميلاد
                </h5>

                <!-- خيار التبديل -->
                <div class="row mb-2">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="manualLocationSwitch">
                            <label class="form-check-label fw-bold" for="manualLocationSwitch">
                                إدخال المحافظة والمديرية يدوياً (خارج القائمة / خارج اليمن)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <!-- 1. المحافظة -->
                    <div class="col-md-4">
                        <!-- Dropdown -->
                        <div class="form-floating" id="govSelectContainer">
                            <select name="governorate_select" class="form-select" id="govSelect">
                                <option value="" selected disabled>اختر المحافظة</option>
                                {% for gov in governorates %}
                                <option value="{{ gov.id }}">{{ gov.name_ar }}</option>
                                {% endfor %}
                            </select>
                            <label for="govSelect">المحافظة</label>
                        </div>
                        <!-- Manual Text (Hidden by default) -->
                        <div class="form-floating d-none" id="govTextContainer">
                            <input type="text" name="governorate_text" class="form-control" id="govInput"
                                placeholder="اسم المحافظة">
                            <label for="govInput">اسم المحافظة (كتابة)</label>
                        </div>
                    </div>

                    <!-- 2. المديرية -->
                    <div class="col-md-4">
                        <!-- Dropdown -->
                        <div class="form-floating" id="dirSelectContainer">
                            <select name="directorate_select" class="form-select" id="dirSelect" disabled>
                                <option value="" selected disabled>اختر المديرية</option>
                            </select>
                            <label for="dirSelect">المديرية</label>
                        </div>
                        <!-- Manual Text (Hidden by default) -->
                        <div class="form-floating d-none" id="dirTextContainer">
                            <input type="text" name="directorate_text" class="form-control" id="dirInput"
                                placeholder="اسم المديرية">
                            <label for="dirInput">اسم المديرية (كتابة)</label>
                        </div>
                    </div>

                    <!-- 3. المكان المحدد (قرية/منزل) -->
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" name="place_of_birth" class="form-control" id="placeOfBirth"
                                placeholder="مكان الميلاد " required>
                            <label for="placeOfBirth">مكان الميلاد (قرية / منزل / مرفق)</label>
                        </div>
                    </div>
                </div>

                <script>
                    document.getElementById('manualLocationSwitch').addEventListener('change', function () {
                        const isManual = this.checked;

                        // Containers
                        const govSelCont = document.getElementById('govSelectContainer');
                        const govTxtCont = document.getElementById('govTextContainer');
                        const dirSelCont = document.getElementById('dirSelectContainer');
                        const dirTxtCont = document.getElementById('dirTextContainer');

                        // Inputs
                        const govSelect = document.getElementById('govSelect');
                        const dirSelect = document.getElementById('dirSelect');
                        const govInput = document.getElementById('govInput');
                        const dirInput = document.getElementById('dirInput');

                        if (isManual) {
                            // Show Text, Hide Select
                            govSelCont.classList.add('d-none');
                            dirSelCont.classList.add('d-none');
                            govTxtCont.classList.remove('d-none');
                            dirTxtCont.classList.remove('d-none');

                            // Require/Enable logic
                            govSelect.disabled = true;
                            dirSelect.disabled = true;
                            govInput.required = true;
                            dirInput.required = true;
                        } else {
                            // Show Select, Hide Text
                            govSelCont.classList.remove('d-none');
                            dirSelCont.classList.remove('d-none');
                            govTxtCont.classList.add('d-none');
                            dirTxtCont.classList.add('d-none');

                            // Require/Enable logic
                            govSelect.disabled = false;
                            // Dir select remains disabled until gov chosen logic handles it
                            govInput.required = false;
                            dirInput.required = false;
                        }
                    });
                </script>

                <h5 class="text-primary mb-3 border-bottom pb-2 mt-5">
                    <i class="fas fa-users me-2"></i>بيانات العائلة
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" name="father_name" class="form-control" id="floatingFather"
                                placeholder="اسم الأب" required>
                            <label for="floatingFather">اسم الأب (الرباعي)</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" name="mother_name" class="form-control" id="floatingMother"
                                placeholder="اسم الأم" required>
                            <label for="floatingMother">اسم الأم (الرباعي)</label>
                        </div>
                    </div>
                </div>

                <div class="border-top pt-4 mt-5">
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill shadow btn-luxury">
                        <i class="fas fa-save me-2"></i>حفظ وإصدار الكرت
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Date Picker
        flatpickr(".flatpickr-date", {
            locale: "ar",
            dateFormat: "Y-m-d",
            maxDate: "today",
            disableMobile: true,
            defaultDate: "today"
        });

        // Dependent Dropdowns Logic
        const govSelect = document.getElementById('govSelect');
        const dirSelect = document.getElementById('dirSelect');

        // 1. On Governorate Change -> Fetch Directorates
        govSelect.addEventListener('change', function () {
            const govId = this.value;

            // Reset Directorate
            dirSelect.innerHTML = '<option value="" selected disabled>جاري جلب البيانات...</option>';
            dirSelect.disabled = true;

            if (govId) {
                const url = `{% url 'centers:api_locations' %}?type=directorate&parent_id=${govId}`;
                console.log("XHR Request to:", url);

                var xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);

                xhr.onreadystatechange = function () {
                    console.log("XHR State:", xhr.readyState, "Status:", xhr.status);
                    if (xhr.readyState === 4) { // Done
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                console.log("Data received:", data);
                                dirSelect.innerHTML = '<option value="" selected disabled>اختر المديرية</option>';

                                if (data.data && data.data.length > 0) {
                                    data.data.forEach(function (item) {
                                        var option = document.createElement('option');
                                        option.value = item.id;
                                        option.textContent = item.name_ar;
                                        dirSelect.appendChild(option);
                                    });
                                    dirSelect.disabled = false;
                                } else {
                                    dirSelect.innerHTML = '<option value="" selected disabled>لا توجد مديريات مسجلة</option>';
                                }
                            } catch (e) {
                                console.error("JSON Parse Error:", e);
                                alert("خطأ في معالجة البيانات: " + e.message);
                            }
                        } else {
                            console.error("Server Error:", xhr.statusText);
                            alert("خطأ من السيرفر: " + xhr.status + " " + xhr.statusText);
                            dirSelect.innerHTML = '<option value="" selected disabled>فشل التحميل (' + xhr.status + ')</option>';
                        }
                    }
                };

                xhr.onerror = function () {
                    console.error("Network Error");
                    alert("خطأ في الاتصال بالشبكة. تأكد لم يتم حظر الرابط.");
                    dirSelect.innerHTML = '<option value="" selected disabled>خطأ في الشبكة</option>';
                };

                xhr.send();
            }
        });

        // 2. On Directorate Change -> No more Center Fetching needed for Text Field
        // dirSelect.addEventListener('change', function () { ... });
    });
</script>
</div>
</div>
</div>
{% endblock %}